/**
 * This file was auto-generated by the Titanium Module SDK helper for Android
 * TiDev Titanium Mobile
 * Copyright TiDev, Inc. 04/07/2022-Present
 * Licensed under the terms of the Apache Public License
 * Please see the LICENSE included with this distribution for details.
 */
package ti.exoplayer;

import android.content.res.Resources;
import android.view.LayoutInflater;

import androidx.media3.common.C;
import androidx.media3.common.MediaItem;
import androidx.media3.common.MediaMetadata;
import androidx.media3.common.Player;
import androidx.media3.exoplayer.ExoPlayer;
import androidx.media3.ui.PlayerView;

import org.appcelerator.kroll.KrollDict;
import org.appcelerator.titanium.TiApplication;
import org.appcelerator.titanium.proxy.TiViewProxy;
import org.appcelerator.titanium.util.TiConvert;
import org.appcelerator.titanium.view.TiUIView;

public class ExoPlayerView extends TiUIView implements Player.Listener {
    private static final String LCAT = "ExoPlayerProxy";
    ExoPlayer player = null;
    String mediaUrl = "";
    boolean isPlaying = false;
    boolean shouldPrepare = false;

    public ExoPlayerView(TiViewProxy proxy) {
        super(proxy);

        String pkgName = proxy.getActivity().getPackageName();
        Resources res = proxy.getActivity().getResources();
        int resId_viewHolder;
        if (TiConvert.toBoolean(proxy.getProperty("audioOnly"), false)) {
            resId_viewHolder = res.getIdentifier("audioplayer_view", "layout", pkgName);
        } else {
            resId_viewHolder = res.getIdentifier("player_view", "layout", pkgName);
        }
        LayoutInflater inflater = LayoutInflater.from(proxy.getActivity());
        PlayerView viewWrapper = (PlayerView) inflater.inflate(resId_viewHolder, null);
        setNativeView(viewWrapper);
        player = new ExoPlayer.Builder(TiApplication.getAppCurrentActivity()).build();
        viewWrapper.setPlayer(player);

        if (!mediaUrl.equals("")) {
            setMediaItem(mediaUrl);
        }

        player.addListener(this);
    }

    @Override
    public void onMediaMetadataChanged(MediaMetadata mediaMetadata) {
        Player.Listener.super.onMediaMetadataChanged(mediaMetadata);
        if (mediaMetadata != null) {
            KrollDict kd = new KrollDict();

            if (mediaMetadata.artist != null) kd.put("album", mediaMetadata.artist);
            if (mediaMetadata.title != null) kd.put("title", mediaMetadata.title);
            if (mediaMetadata.albumTitle != null) kd.put("albumTitle", mediaMetadata.albumTitle);
            if (mediaMetadata.albumArtist != null) kd.put("albumArtist", mediaMetadata.albumArtist);
            if (mediaMetadata.artworkUri != null)
                kd.put("artworkUrl", mediaMetadata.artworkUri.toString());
            /*if (mediaMetadata.artworkData != null) {
                kd.put("artwork", TiConvert.toBlob(mediaMetadata.artworkData));
            }*/

            fireEvent("metaData", kd);
        }
    }

    @Override
    public void onPlaybackStateChanged(int playbackState) {
        Player.Listener.super.onPlaybackStateChanged(playbackState);
        KrollDict kd = new KrollDict();
        if (playbackState == Player.STATE_BUFFERING) {
            kd.put("state", TiExoPlayerModule.STATE_BUFFERING);
        } else if (playbackState == Player.STATE_IDLE) {
            kd.put("state", TiExoPlayerModule.STATE_IDLE);
        } else if (playbackState == Player.STATE_READY) {
            kd.put("state", TiExoPlayerModule.STATE_READY);
        } else if (playbackState == Player.STATE_ENDED) {
            kd.put("state", TiExoPlayerModule.STATE_ENDED);
        }
        fireEvent("playerState", kd);
    }

    @Override
    public void onEvents(Player player, Player.Events events) {
        Player.Listener.super.onEvents(player, events);
    }

    @Override
    public void onIsPlayingChanged(boolean isPlaying) {
        Player.Listener.super.onIsPlayingChanged(isPlaying);
        KrollDict kd = new KrollDict();
        kd.put("state", TiExoPlayerModule.STATE_PLAYING);
        this.isPlaying = isPlaying;
        fireEvent("playerState", kd);
    }

    @Override
    public void onPositionDiscontinuity(Player.PositionInfo oldPosition, Player.PositionInfo newPosition, int reason) {
        Player.Listener.super.onPositionDiscontinuity(oldPosition, newPosition, reason);
        KrollDict kd = new KrollDict();
        kd.put("oldPosition", oldPosition.positionMs);
        kd.put("position", newPosition.positionMs);
        fireEvent("seek", kd);
    }

    @Override
    public void processProperties(KrollDict d) {
        super.processProperties(d);
    }

    public void setMediaItem(String url) {
        mediaUrl = url;
        if (player != null) {
            MediaItem mediaItem = MediaItem.fromUri(mediaUrl);
            player.setMediaItem(mediaItem);
            player.prepare();
            shouldPrepare = false;
        }
    }

    public void play() {
        if (shouldPrepare) {
            player.prepare();
        }
        player.play();
    }

    public void stop() {
        player.stop();
        shouldPrepare = true;
    }

    public void pause() {
        player.pause();
    }

    public void release() {
        player.release();
    }
    public long currentPosition() {
        long currentPosition = player.getCurrentPosition();
        return currentPosition;
    }

    public long duration() {
        long duration = player.getDuration();
        if (duration == C.TIME_UNSET) {
            return -1;
        } else {
            return player.getDuration();
        }
    }

    public void seekTo(int value) {
        player.seekTo(value);
    }
}
